name: Continuous Integration
on:
  push:
    branches: [ "main" ]

  workflow_dispatch:
  
permissions: write-all

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: iterative/setup-cml@v2
      - name: Install Packages
        run: make install
      - name: Format
        run: make format
      - name: Train
        run: make train
      - name: Evaluation
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: make eval
      - name: Update Branch
        env:
          NAME: ${{ secrets.USER_NAME }}
          EMAIL: ${{ secrets.USER_EMAIL }}
        run: make update-branch USER_NAME=$NAME USER_EMAIL=$EMAIL

      - name: Check USER_NAME
        env:
          USER: ${{ secrets.USER_NAME }}
        run: test -n "$USER" || (echo "USER_NAME is empty" && exit 1)

      - name: Check HF_TOKEN
        env:
          HF: ${{ secrets.HF_TEST }}
        run: test -n "$HF" || (echo "HF_TOKEN is empty" && exit 1)
          
  deploy:
    needs: build
    uses: ./.github/workflows/cd.yml
    secrets:
      HF_TEST: ${{ secrets.HF_TEST }}

    
